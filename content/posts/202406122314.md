+++
title = "Disqusが勝手にテキストをリンク化するのを防ぐ"
date = 2024-06-12T23:32:00+09:00
tags = ["general", "hugo"]
draft = false
archives = ["""
  "2024"
  """, """
  "2024-06"
  """]
+++

このブログでは、よくクラウドやKubernetesに関するエントリを扱っています。

そのため、 `networking.k8s.io/v1` のように、URLっぽいテキストが出てくることがあるのですが、
いつのまにか、勝手にこれらのテキストがリンクとして扱われていることに気付きました。

特にコードスニペット中のテキストがリンク化してしまうと、シンタックスハイライトに被り、見づらくなってしまいます。
そのため、Aタグは外そうと見直していたのですが、よくよく考えてみるとAタグなんてわざわざ付けていません。
また、リンクになってしまう現象はローカルでは発生しておらず、本番環境でのみ発生していることに気付き、改めて原因の調査をおこないました。


## わかったこと {#わかったこと}

-   本番環境でのみ発生する
-   ページをロードした直後はリンク化しておらず、しばらくするといつの間にかリンクに変化している
-   ただのリンクではなく `class=vglnk` と、Classが付与されている

ここまで調べてみて、明らかに本番でのみ動かしている何かが、悪さをしていると判断できたため、
勝手に付与されているClassと共に調査しました。


## 犯人 {#犯人}

犯人は、コメント用に設置しているDisqusプラグインでした。
これがロードされるときに、URLっぽい文字列を勝手にリンク化してしまうようです。

{{< figure src="/ox-hugo/20240612-disqus.png" >}}

さらに調査を続けると、上記の詳細設計の `Affiliate links` なるチェックボックスが有効化されている場合に、
この現象が発生することがわかりました。

この機能は、VigLinkという海外のアフィリエイトサイトの機能を利用していて、
URLっぽい文字列や、アフィリエイトが使えるが設定がされていないサイトへのリンクを
かたっぱしからアフィリエイトコードを追加するように書き換えてくれるそうです。

大きなお世話すぎる……!!

こんな機能は不要なのでオフにしたところ、本番環境でも勝手にリンクが貼られなくなりました。


## まとめ {#まとめ}

文章のチェックは執筆時にローカルで見てしまうので、本番環境の内容はざっと見るぐらいだったのが敗因でした。
これまで特に害は無かったと思うのですが、この辺のサードパーティツールを使うときは気をつけないとな、と思いました。

今回、Disqusの設定を見直した際に、ゲスト投稿を有効に切り替えたので、
もしお気付きの点などありましたら、是非コメントにお寄せください。
